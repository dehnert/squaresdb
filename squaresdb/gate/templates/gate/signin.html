{% extends "base.html" %}

{% block title %}Signin for {{dance.time}}{% endblock %}

{% block content %}

<h1>Squares Signin for {{dance.time}}</h1>

<p>Accepting signins for {{people|length}} people, including {{subscribers|length}} subscribers for {{period.name}}.</p>

<p>If you haven't done jobs before, see the <a href="https://www.mit.edu/~tech-squares/howto/">directions</a>.
You can also <a href='{% url "gate:books-dance" dance.pk %}'>view books</a> if you have permissions.</p>

<!-- I kinda prefer this floated on a laptop, but on a tablet I suspect we lack the space, plus the attendance alerts seem to cover it -->
<!--<div class="float-lg-right">-->
<div>
<h2>Prices</h2>
<table class='table table-striped table-bordered' style='width: auto'>
  <thead>
    <tr>
      <th scope='col'>For...</th>
      <th scope='col'>Dance</th>
      {% for period in subscription_periods %}
      <th scope='col'>{{period.name}}</th>{% endfor %}
    </tr>
  </thead>

  <tbody>
{% for slug, row in price_matrix.items %}
    <tr>
      <th scope='row'>{{row.cat_name|capfirst}}</th>
      {% for col in row.prices.values %}
      <td>{{col.2}}</td>{% endfor %}
    </tr>
{% endfor %}
  </tbody>
</table>
{{price_matrix|json_script:"price_matrix"}}
</div>

{% if not price_matrix.items %}
<div class="alert alert-danger" role="alert">
    <p>Prices have not been input into SquaresDB, and some functionality will not work correctly. Please reach out to <a href="mailto:squares-db-request@mit.edu">a DB admin or officer</a> to get this fixed.</p>
</div>
{% endif %}

<p>After each name below is a two-character code:
"M" indicates MIT students, "s" indicates student or financial aid, "f" indicates full price.
"+" indicates a current subscription, while "-" indicates no current subscription.</p>
<p>People in green don't need to pay &ndash; they're current students or have a subscription, and clicking on them will immediately mark them present.
People in gray, with an arrow next to them, do need to pay &ndash; clicking them will allow marking them as present or paid.</p>

<h2>Attendance</h2>

<script>
  var dance_id = {{dance.pk}};

  // Alert types:
  // Primary: one-off payments (cash, other)
  // Secondary: subscription
  // Success: no payment (expected)
  // Warning: no payment (unexpected)
  function addPaymentMessage(type, name, message) {
    var html = `
      <div class="alert alert-${type}" role="alert">
          <strong>${name}</strong> <span class='verb'>is being</span> marked as ${message}.
	  <button type="button" class="btn btn-dark btn-sm">Undo</button>
	  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
	      <span aria-hidden="true">&times;</span>
	  </button>
      </div>
    `;
    return jQuery('#paymentMessages').append(html);
  }
</script>

<div id='paymentMessages'>
</div>

<form class="form-inline">
  <div class='form-group'>
    <label for='signinFilter'>Filter:&nbsp;</label>
    <input class="form-control mr-sm-2" type="search" id='signinFilter' placeholder="Name" aria-label="Filter">
  </div>
</form>

{% csrf_token %}
<script type="text/javascript">
var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

function makePaymentAJAX(data, msg) {
  console.log(data);
  args = {
    url: '{% url "gate:signin-api" %}',
    data: data,
    success: function(event) {
        console.log("got reply"); console.log(event);
        msg.find(".verb").replaceWith("<span class='verb'>has been</span>");
    },
    beforeSend: function(xhr, settings) {
	if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
	    xhr.setRequestHeader("X-CSRFToken", csrftoken);
	}
    }
  }
  fail_cb = function(jqXHR, textStatus, errorThrown) {
    console.log("makePaymentAJAX failed");
    console.log(jqXHR);
    msg.find(".verb").replaceWith("<span class='verb'>failed to be</span>");
    msg.find(".alert").attr("class", "alert alert-danger");
    var error = jqXHR.responseJSON['msg'];
    console.log("Got error " + error);
    var tmpl = "<p>Server said: <span class='server-error'></span></p>";
    msg.find(".alert").append(tmpl).find("span.server-error").text(error);
  };
  jQuery.post(args).fail(fail_cb);
}

function processCashPayment(button, amount) {
  var dropdown = jQuery(button).parent().parent()
  var person_name = dropdown.data('name') // Extract info from data-* attributes
  var person_id = dropdown.data('id') // Extract info from data-* attributes
  var ajax_data = {
    'person': person_id,
    'dance': dance_id,
    'present': true,
    'paid': true,
    'paid_amount': amount,
    'paid_method': 'cash',
    'paid_for': 'dance',
  };
  var message = 'present and paid $' + amount;
  msg = addPaymentMessage('primary', person_name, message);
  makePaymentAJAX(ajax_data, msg);
}

function markPresentOnlyExpected(button) {
  var person_name = jQuery(button).data('name') // Extract info from data-* attributes
  var person_id = jQuery(button).data('id') // Extract info from data-* attributes
  var ajax_data = {
    'person': person_id,
    'dance': dance_id,
    'present': true,
    'paid': false,
  };
  var message = 'present (no payment needed)';
  msg = addPaymentMessage('success', person_name, message);
  makePaymentAJAX(ajax_data, msg);
}

function markPresentOnlyUnexpected(button) {
  var dropdown = jQuery(button).parent().parent()
  var person_name = dropdown.data('name') // Extract info from data-* attributes
  var person_id = dropdown.data('id') // Extract info from data-* attributes
  var ajax_data = {
    'person': person_id,
    'dance': dance_id,
    'present': true,
    'paid': false,
  };
  var message = 'present and but not paid';
  msg = addPaymentMessage('warning', person_name, message);
  makePaymentAJAX(ajax_data, msg);
}
</script>

<script>
function signinFilter(element) {
    var $people = $('#signinList > span').add('#signinList > button').hide();
    var regexp = new RegExp($(element).val(), 'i');

    var $valid = $people.filter(function () {
        return regexp.test($(this).data('name'))
    }).show();

    $people.not($valid).hide()
}

$('#signinFilter').on('keyup change', function () {
    signinFilter(this);
})
</script>

<div class="modal fade" id="subscriptionModal" tabindex="-1" role="dialog" aria-labelledby="subscriptionModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="subscriptionModalLabel">Buy Subscription</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="subscriptionForm">
          <div class="form-group">
            <label for="person-name" class="col-form-label">Purchaser:</label>
            <input type="text" class="form-control-plaintext" id="person-name" readonly>
          </div>
          <input type="hidden" id="person-id">
          <fieldset class="form-group">
              <legend class="col-form-label">Subscription period:</legend>
              {% for period in subscription_periods %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="subscriptionPeriod" id="subscriptionPeriod{{period.slug}}" value="{{period.slug}}" checkbox>
                  <label class="form-check-label" for="subscriptionPeriod{{period.slug}}">
		    {{period.name}}<span class='subPeriodPrices' id='subPeriodPrice-{{period.slug}}'></span>
                  </label>
                </div>
              {% endfor %}
          </fieldset>
          <div class="form-group">
            <label for="payment-amount" class="col-form-label">Payment amount:</label>
            <input class="form-control" type="number" id="payment-amount"></textarea>
          </div>
          <fieldset class="form-group">
              <legend class="col-form-label">Payment method:</legend>
              {% for method in payment_methods %}
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="paymentMethod" id="paymentMethod{{method.slug}}" value="{{method.slug}}">
                  <label class="form-check-label" for="paymentMethod{{method.slug}}">
                    {{method.name}}
                  </label>
                </div>
              {% endfor %}
          </fieldset>
          <div class="form-group">
            <label for="notes" class="col-form-label">Notes:</label>
            <textarea class="form-control" id="notes"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary" form='subscriptionForm'>Buy</button>
      </div>
    </div>
  </div>
</div>
<script>
$('#subscriptionModal').on('show.bs.modal', function (event) {
  var button = $(event.relatedTarget) // Button that triggered the modal
  var dropdown = button.parent().parent()
  var person_id = dropdown.data('id') // Extract info from data-* attributes
  var person_name = dropdown.data('name') // Extract info from data-* attributes
  var fee_cat = dropdown.data('fee-cat') // Extract info from data-* attributes
  var modal = $(this)
  modal.find('.modal-title').text('New subscription for ' + person_name)
  modal.find('.modal-body input#person-id').val(person_id)
  modal.find('.modal-body input#person-name').val(person_name)
  modal.find('.modal-body textarea#notes').text('')

  var price_matrix = JSON.parse(document.getElementById('price_matrix').textContent);
  var our_prices = price_matrix[fee_cat]['prices'];
  modal.find('.subPeriodPrices').text('')
  for (slug in our_prices) {
    if (slug == 'dance') continue;
    if (our_prices[slug] == null) continue;
    modal.find('#subPeriodPrice-'+slug).text(" ("+our_prices[slug][2]+")");
  }
})
$('#subscriptionForm').on('submit', function (event) {
  event.preventDefault();
  var form = $(event.target)[0];
  periods = [];
  console.log(form.elements['subscriptionPeriod']);
  for (i = 0; i < form.elements.length; i++) {
    var radio = form.elements[i];
    if (radio.name == "subscriptionPeriod" && radio.checked) {
      periods.push(radio.value);
    }
  }
  var person_name = form.elements['person-name'].value;
  var paid_amount = form.elements['payment-amount'].value;
  var notes = form.elements['notes'].value;
  var ajax_data = {
    'person':form.elements['person-id'].value,
    'dance': dance_id,
    'present': true,
    'paid': true,
    'paid_amount': paid_amount,
    'paid_method': form.elements['paymentMethod'].value,
    'paid_for': 'sub',
    'paid_period': periods,
    'notes': notes,
  };
  var message = 'present and bought a subscription for $' + paid_amount;
  msg = addPaymentMessage('secondary', person_name, message);
  makePaymentAJAX(ajax_data, msg);
  jQuery('#subscriptionModal').modal('hide');
})
</script>

<div class="modal fade" id="danceModal" tabindex="-1" role="dialog" aria-labelledby="danceModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="danceModalLabel">Dance payment</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="danceForm">
          <div class="form-group">
            <label for="person-name" class="col-form-label">Purchaser:</label>
            <input type="text" class="form-control-plaintext" id="person-name" readonly>
          </div>
          <input type="hidden" id="person-id">
          <div class="form-group">
            <label for="payment-amount" class="col-form-label">Payment amount:</label>
            <input class="form-control" type="number" id="payment-amount"></textarea>
          </div>
          <fieldset class="form-group">
              <legend class="col-form-label">Payment method:</legend>
              {% for method in payment_methods %}
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="paymentMethod" id="paymentMethod{{method.slug}}" value="{{method.slug}}">
                  <label class="form-check-label" for="paymentMethod{{method.slug}}">
                    {{method.name}}
                  </label>
                </div>
              {% endfor %}
          </fieldset>
          <div class="form-group">
            <label for="notes" class="col-form-label">Notes:</label>
            <textarea class="form-control" id="notes"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary" form="danceForm">Buy</button>
      </div>
    </div>
  </div>
</div>
<script>
$('#danceModal').on('show.bs.modal', function (event) {
  var button = $(event.relatedTarget) // Button that triggered the modal
  var dropdown = button.parent().parent()
  var person_id = dropdown.data('id') // Extract info from data-* attributes
  var person_name = dropdown.data('name') // Extract info from data-* attributes
  var payment_amount = dropdown.data('price-high') // Extract info from data-* attributes
  var modal = $(this)
  modal.find('.modal-title').text('New payment for ' + person_name)
  modal.find('.modal-body input#person-id').val(person_id)
  modal.find('.modal-body input#person-name').val(person_name)
  modal.find('.modal-body input#payment-amount').val(payment_amount)
  modal.find('.modal-body textarea#notes').text('')
})

$('#danceForm').on('submit', function (event) {
  event.preventDefault();
  var form = $(event.target)[0];
  var person_name = form.elements['person-name'].value;
  var paid_amount = form.elements['payment-amount'].value;
  var notes = form.elements['notes'].value;
  var ajax_data = {
    'person':form.elements['person-id'].value,
    'dance': dance_id,
    'present': true,
    'paid': true,
    'paid_amount': paid_amount,
    'paid_method': form.elements['paymentMethod'].value,
    'paid_for': 'dance',
    'notes': notes,
  };
  var message = 'present and paid $' + paid_amount;
  msg = addPaymentMessage('primary', person_name, message);
  makePaymentAJAX(ajax_data, msg);
  jQuery('#danceModal').modal('hide');
})
</script>

<div style='line-height: 3' id='signinList'>
{% for person in people %}
  {% ifchanged person.frequency %}
  <h3>Attends: {{person.frequency.name|capfirst}}</h3>
  {% endifchanged %}

  <!-- TODO: better way to decide which button to show -->
  {% if person.fee_cat.slug == "mit-student" or person in subscribers %}
    <button type="button" class="btn btn-success" data-name="{{person.name}}" data-id="{{person.id}}" onclick="markPresentOnlyExpected(this)">{{person.name}} ({{person.signin_label}})</button>
  {% else %}
    {% with dance_price=person.prices.dance.1 %}
    <span class='dropdown' data-name="{{person.name}}" data-id="{{person.id}}" data-price-high="{{dance_price}}" data-fee-cat="{{person.fee_cat.slug}}">
        <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{person.name}} ({{person.signin_label}})</button>

        <div class="dropdown-menu">
	    <button class="dropdown-item" onclick="processCashPayment(this, {{dance_price}})">Paid ${{dance_price}} cash</button>
            <button class="dropdown-item" type="button" data-toggle="modal" data-target="#subscriptionModal" data-id="{{person.id}}">Bought subscription</button>
            <button class="dropdown-item" type="button" data-toggle="modal" data-target="#danceModal" data-id="{{person.id}}">Paid other amount or mechanism</button>
            <button class="dropdown-item" onclick="markPresentOnlyUnexpected(this)">Present but didn't pay</button>
        </div>
    </span>
    {% endwith %}
  {% endif %}
{% endfor %}
</div>

{% endblock %}
